# BSL Type Safety MCP Server

Model Context Protocol server для предоставления информации о типах BSL (1C:Enterprise) для LLM.

## Возможности

MCP сервер предоставляет единственный инструмент для работы с типовой системой BSL:

1. **find_type** - Поиск типа в индексе BSL и получение полной информации о нем

## Установка

### Сборка из исходников

```bash
cargo build --release --bin bsl-mcp-server
```

### Переменные окружения

- `BSL_CONFIG_PATH` - путь к конфигурации 1С для автоматической загрузки
- `BSL_PLATFORM_VERSION` - версия платформы (по умолчанию "8.3.25")

## Запуск

### Standalone режим

```bash
# С автоматической загрузкой конфигурации
BSL_CONFIG_PATH="C:\Config\MyConfig" BSL_PLATFORM_VERSION="8.3.25" bsl-mcp-server

# Без предварительной загрузки
bsl-mcp-server
```

### Интеграция с Claude Desktop

Добавьте в файл конфигурации Claude Desktop:

```json
{
  "mcpServers": {
    "bsl-types": {
      "command": "C:\\path\\to\\bsl-mcp-server.exe",
      "env": {
        "BSL_CONFIG_PATH": "C:\\Config\\MyConfig",
        "BSL_PLATFORM_VERSION": "8.3.25"
      }
    }
  }
}
```

## Использование инструментов

### find_type

Поиск типа в индексе BSL. Возвращает полную информацию о типе, включая свойства, методы, табличные части и формы.

**Параметры:**
- `type_name` (обязательный) - имя типа для поиска (поддерживает русские и английские названия)

**Примеры использования:**

#### Платформенный тип
```json
{
  "name": "find_type",
  "arguments": {
    "type_name": "Массив"
  }
}
```

Ответ:
```json
{
  "found": true,
  "entity": {
    "id": "Массив (Array)",
    "display_name": "Массив (Array)",
    "entity_type": "Platform",
    "entity_kind": "System",
    "methods_count": 9,
    "properties_count": 0,
    "tabular_sections": []
  }
}
```

#### Объект конфигурации (справочник)
```json
{
  "name": "find_type",
  "arguments": {
    "type_name": "Справочники.Контрагенты"
  }
}
```

Ответ:
```json
{
  "found": true,
  "entity": {
    "id": "Справочники.Контрагенты",
    "display_name": "Контрагенты",
    "entity_type": "Configuration",
    "entity_kind": "Catalog",
    "methods_count": 0,
    "properties_count": 16,
    "tabular_sections": [
      {
        "name": "КонтактнаяИнформация",
        "display_name": "КонтактнаяИнформация",
        "attributes_count": 13
      },
      {
        "name": "ДополнительныеРеквизиты",
        "display_name": "ДополнительныеРеквизиты",
        "attributes_count": 3
      },
      {
        "name": "ИсторияКПП",
        "display_name": "ИсторияКПП",
        "attributes_count": 2
      },
      {
        "name": "ИсторияНаименований",
        "display_name": "ИсторияНаименований",
        "attributes_count": 2
      },
      {
        "name": "ИсторияКонтактнойИнформации",
        "display_name": "ИсторияКонтактнойИнформации",
        "attributes_count": 5
      }
    ]
  }
}
```

#### Объект конфигурации (документ)
```json
{
  "name": "find_type",
  "arguments": {
    "type_name": "Документы.РеализацияТоваровУслуг"
  }
}
```

Ответ включает информацию о 38 свойствах и 8 табличных частях документа.

#### Тип не найден
```json
{
  "name": "find_type",
  "arguments": {
    "type_name": "НесуществующийТип"
  }
}
```

Ответ:
```json
{
  "found": false,
  "suggestions": [
    "СуществующийТип1",
    "СуществующийТип2"
  ]
}
```


## Архитектура

MCP сервер построен на основе:

- **UnifiedBslIndex** - единый индекс всех типов BSL (7,000+ типов для конфигурации Unicom)
- **Простой JSON-RPC протокол** - реализация без внешних MCP библиотек
- **tokio** - асинхронный runtime

### Производительность

- Загрузка индекса: ~6.6s (первый раз для Unicom), ~0.5s (из кеша)
- Поиск типа: <1ms
- Размер индекса: ~7,000 типов (3,918 платформенных + объекты конфигурации)

## Разработка

### Структура проекта

```
src/bin/
└── mcp_server.rs   # Простая реализация JSON-RPC сервера

src/unified_index/
├── builder.rs      # Построение индекса
├── entity.rs       # Структуры данных (включая BslTabularSection)
├── xml_parser.rs   # Парсер XML конфигурации с поддержкой табличных частей
└── ...
```

### Текущая реализация

MCP сервер реализован как простой JSON-RPC сервер без использования внешних MCP библиотек из-за нестабильности их API.

### Тестирование

```bash
# Сборка MCP сервера
cargo build --bin bsl-mcp-server

# Запуск с конфигурацией Unicom
BSL_CONFIG_PATH="C:\1CProject\Unicom\conf_files" cargo run --bin bsl-mcp-server

# Тестирование с помощью Node.js клиента
cd tests/mcp
npm install
node test_mcp_server.js
```

## Примеры использования

### Получение информации о типе

```
User: Какие табличные части есть у справочника Контрагенты?

Assistant использует MCP инструмент find_type и получает:
- КонтактнаяИнформация (13 атрибутов)
- ДополнительныеРеквизиты (3 атрибута)
- ИсторияКПП (2 атрибута)
- ИсторияНаименований (2 атрибута)
- ИсторияКонтактнойИнформации (5 атрибутов)
```

### Работа с документами

```
User: Сколько табличных частей у документа РеализацияТоваровУслуг?

Assistant использует MCP инструмент find_type и видит 8 табличных частей:
- Товары (37 атрибутов)
- ВозвратнаяТара (6 атрибутов)
- Услуги (14 атрибутов)
- АгентскиеУслуги (12 атрибутов)
- ЗачетАвансов (2 атрибута)
- ШтрихкодыУпаковок (3 атрибута)
- СведенияПрослеживаемости (9 атрибутов)
- Смета (6 атрибутов)
```

## Ограничения текущей версии

- Поддерживается только один инструмент `find_type`
- Нет детальной информации о методах и их параметрах
- Нет проверки совместимости типов
- Нет валидации вызовов методов

## Дорожная карта

- [ ] Добавить инструмент `get_type_methods` для получения методов с параметрами
- [ ] Добавить инструмент `check_type_compatibility` для проверки совместимости
- [ ] Добавить инструмент `validate_method_call` для валидации вызовов
- [ ] Перейти на официальный Rust MCP SDK когда стабилизируется API
- [ ] Добавить поддержку инкрементального обновления индекса