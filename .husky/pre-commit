#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit hook for BSL Analyzer
echo "🔍 BSL Analyzer Pre-commit Checks"

# Check for significant code changes that might warrant version increment
STAGED_FILES=$(git diff --cached --name-only)

# Count changed files by type
RUST_CHANGES=$(echo "$STAGED_FILES" | grep -cE "^src/.*\.rs$|^Cargo\.(toml|lock)$" || echo "0")
EXT_CHANGES=$(echo "$STAGED_FILES" | grep -cE "^vscode-extension/src/.*\.ts$|^vscode-extension/package\.json$" || echo "0")

echo "📊 Staged changes: Rust files: $RUST_CHANGES, Extension files: $EXT_CHANGES"

# Check version synchronization before commit
echo "🔄 Checking version synchronization..."

# Use the build system with version awareness
# Note: Pre-commit rebuilds without version increment - versions should be managed explicitly
echo "🚀 Running pre-commit rebuild (without auto-versioning)..."
npm run rebuild:extension

if [ $? -ne 0 ]; then
    echo "❌ Pre-commit rebuild failed"
    exit 1
fi

echo "💡 Tip: Use 'npm run build:patch' to auto-increment version and rebuild"
echo "✅ Pre-commit checks completed"
