#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit hook for BSL Analyzer
echo "ğŸ” BSL Analyzer Pre-commit Checks"

# Check for significant code changes that might warrant version increment
STAGED_FILES=$(git diff --cached --name-only)

# Count changed files by type
RUST_CHANGES=$(echo "$STAGED_FILES" | grep -cE "^src/.*\.rs$|^Cargo\.(toml|lock)$" || echo "0")
EXT_CHANGES=$(echo "$STAGED_FILES" | grep -cE "^vscode-extension/src/.*\.ts$|^vscode-extension/package\.json$" || echo "0")

echo "ğŸ“Š Staged changes: Rust files: $RUST_CHANGES, Extension files: $EXT_CHANGES"

# Check version synchronization before commit
echo "ğŸ”„ Checking version synchronization..."

# Use the build system with version awareness
# Note: Pre-commit rebuilds without version increment - versions should be managed explicitly
echo "ğŸš€ Running pre-commit rebuild (without auto-versioning)..."
npm run rebuild:extension

if [ $? -ne 0 ]; then
    echo "âŒ Pre-commit rebuild failed"
    exit 1
fi

echo "ğŸ’¡ Tip: Use 'npm run build:patch' to auto-increment version and rebuild"
echo "âœ… Pre-commit checks completed"
