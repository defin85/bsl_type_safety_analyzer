# План рефакторинга парсеров для работы с реальными отчетами конфигурации 1С

## Анализ различий форматов

### 1. Пример из нашего проекта (sample_config_report.txt)
```
Справочник.Номенклатура
  Код (Строка(9))
  Наименование (Строка(150))
```

### 2. Реальный формат отчета из 1С
```
	 -   !?@02>G=8:8. >=B@035=BK 
	 	 	 <O:   " >=B@035=BK"  
	 	 	 !8=>=8<:   " >=B@035=BK"  
	 	 	 ><<5=B0@89:   " "  
	 	 	 @8=04;56=>ABL1J5:B0:   " !>1AB25==K9"  
```

### 3. Формат из Python проекта (onec-contract-generator)
```
- Справочники.Контрагенты
  Комментарий: "Справочник контрагентов предприятия"
  Тип: СправочникСсылка.Контрагенты
  - Справочники.Контрагенты.Реквизиты.Наименование
    Комментарий: "Наименование контрагента"
    Тип: Строка
```

## Ключевые различия

1. **Кодировка**: Реальные отчеты в UTF-16 с искаженными символами
2. **Структура**: 
   - Реальный: использует табы и префикс "-" 
   - Python: использует "-" и отступы
   - Наш пример: без префиксов, простые отступы
3. **Метаданные**: Реальный формат содержит много дополнительных свойств (Имя, Синоним, Комментарий, Принадлежность и т.д.)

## План рефакторинга

### Фаза 1: Изучение и анализ (COMPLETED)
- [x] Изучить исходный парсер Python onec-contract-generator
- [x] Изучить формат реального отчета конфигурации
- [x] Проанализировать маленький пример отчета

### Фаза 2: Обновление парсера метаданных
1. **Поддержка реального формата**:
   - Добавить обработку префикса "-" перед типами объектов
   - Правильно обрабатывать табуляцию и отступы
   - Парсить поля в формате `ИмяПоля: "Значение"`

2. **Расширение типов объектов**:
   - Синхронизировать список ALLOWED_ROOT_TYPES с Python версией
   - Добавить поддержку всех типов из реального отчета

3. **Улучшение парсинга структуры**:
   - Обработка вложенных реквизитов (Справочники.Контрагенты.Реквизиты.ИНН)
   - Поддержка табличных частей
   - Извлечение типов данных из поля "Тип:"

### Фаза 3: Обновление парсера форм
1. Изучить структуру реальных XML форм в C:\1CProject\Unicom\conf_files
2. Адаптировать парсер под реальную структуру

### Фаза 4: Создание универсального парсера
1. Объединить логику для разных форматов отчетов
2. Автоматическое определение формата
3. Поддержка как примеров, так и реальных отчетов

### Фаза 5: Обновление примеров и тестов
1. Создать реалистичный пример отчета на основе ОтчетПоКонфигурации888.txt
2. Обновить тесты для работы с реальным форматом
3. Добавить интеграционные тесты с реальными данными

## Технические детали реализации

### 1. Парсинг строк в реальном формате
```rust
// Пример парсинга строки: "	 -   !?@02>G=8:8. >=B@035=BK"
fn parse_real_format_line(line: &str) -> Option<ObjectInfo> {
    // Декодировать UTF-16 искаженные символы
    let decoded = decode_corrupted_utf16(line);
    
    // Проверить префикс "-"
    if decoded.trim().starts_with("-") {
        let object_path = decoded.trim_start_matches("-").trim();
        // Парсить путь объекта
        return parse_object_path(object_path);
    }
    
    // Парсить свойства в формате "Имя: \"Значение\""
    if let Some((key, value)) = parse_property_line(&decoded) {
        // Обработать свойство
    }
}
```

### 2. Определение формата отчета
```rust
enum ReportFormat {
    SimplifiedExample,  // Наш упрощенный формат
    PythonStyle,       // Формат из Python проекта
    RealReport,        // Реальный отчет из 1С
}

fn detect_report_format(content: &str) -> ReportFormat {
    // Логика определения формата по первым строкам
}
```

### 3. Универсальный интерфейс
```rust
trait ConfigurationReportParser {
    fn parse(&self, content: &str) -> Result<Vec<MetadataContract>>;
    fn supports_format(&self, format: ReportFormat) -> bool;
}
```

## Приоритеты

1. **Высокий**: Поддержка реального формата отчетов (как в Unicom)
2. **Средний**: Совместимость с Python форматом для миграции
3. **Низкий**: Поддержка упрощенного формата для примеров

## Ожидаемый результат

После рефакторинга парсеры должны:
1. Успешно парсить реальные отчеты конфигурации из Unicom
2. Извлекать все метаданные объектов с их структурой
3. Сохранять в гибридный формат документации
4. Работать с различными форматами отчетов