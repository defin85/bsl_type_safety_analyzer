# BSL Type Safety Analyzer — Сводный документ по архитектуре, унификации и рефакторингу

Дата: 2025-08-08
Статус: Действующий сводный документ (замещает: ANALYZER_UNIFICATION.md, REFACTORING_ANALYSIS.md, REFACTORING_PROGRESS.md). Приоритет над другими документами.

## Цель

Единым источником зафиксировать:
- целевую архитектуру и фактическое состояние кода,
- результаты унификации/рефакторинга,
- известные расхождения и ближайшие шаги.

## Архитектура (Core + Shell)

- Core
   - UnifiedBslIndex: единое хранилище типов (платформа + конфигурация), кэш платформы и проекта.
   - BslAnalyzer: единый анализатор с уровнями AnalysisLevel (Syntax, Semantic, DataFlow, Full) и AnalysisConfig.
   - Парсинг: tree-sitter стек для кода BSL; XML-парсеры для метаданных.
- Shell
   - LSP Server (tower-lsp): преобразование результатов анализа в LSP Diagnostics, completion/hover и пр.
   - CLI утилиты: используют общий модуль cli_common (логирование, вывод, прогресс, трейт CliCommand).
   - VSCode Extension: обертка над LSP.

Текущее состояние в коде:
- BslAnalyzer/AnalysisLevel/AnalysisConfig: реализованы (src/bsl_parser/analyzer.rs) и используются в CLI и LSP.
- LSP интеграция с BslAnalyzer и UnifiedBslIndex: реализована (src/lsp/server.rs, src/lsp/diagnostics.rs).
- Централизованные конвертеры: src/unified_index/converters/{mod,syntax_db,methods,properties}.rs.
- Иерархия типов: src/unified_index/hierarchy.rs (имеет предупреждения об неиспользуемых полях/методах — не критично).

## Результаты унификации и рефакторинга

- Единый анализатор
   - Внедрен BslAnalyzer с уровнями анализа и настраиваемым AnalysisConfig.
   - CLI и LSP используют общий анализатор, диагностика унифицирована через конвертер (lsp/diagnostics.rs).
- Централизация конвертеров
   - Конвертация BslSyntaxDatabase → BslEntity вынесена в SyntaxDbConverter (исправлен баг перезаписи; объем типов вырос до ~4167).
   - Конвертеры методов/свойств сгруппированы и переиспользуются.
- CLI общая основа
   - Модуль cli_common: args/output/progress, трейт CliCommand; подключен в ключевых бинарниках.
- Производительность и кэш
   - Экстракция платформенных типов из примеров (examples/rebuilt.shcntx_ru.zip) формирует кэш в %USERPROFILE%\.bsl_analyzer\platform_cache\<version>.jsonl.

## Известные расхождения и риски

- Именование примитивов в платформенном кэше
   - Текущая генерация использует формат дисплея вида «Строка (String)», «Число (Number)» и т.п.
   - Часть тестов ожидает наличие базовых русских имен без суффиксов («Число», «Булево»).
   - Итог: один тест падает (bsl_parser::keywords::keyword_generator::tests::test_platform_cache_loading), функциональность не страдает.
- Версионные несоответствия в документации (1.7.1/1.8.0/1.9.0)
   - Требуется синхронизация версий и статусных блоков в README/docs.

## Принятые решения (актуально)

- Parser: tree-sitter для кода (logos+nom — только как legacy-компоненты, не развиваем).
- Storage: UnifiedBslIndex вместо HybridStorage.
- IDE интеграция: LSP-first; расширение VSCode — оболочка.
- Приоритет полноты знаний (для LLM/IDE) над жесткой экономией памяти.

## Контрольный список (актуальность)

- [x] Единый анализатор (BslAnalyzer) с уровнями анализа — внедрен и используется.
- [x] Конвертеры централизованы — внедрено (syntax_db, methods, properties).
- [x] CLI унифицирован (cli_common) — внедрено.
- [x] LSP использует BslAnalyzer и унифицированные diagnostics — внедрено.
- [x] Платформенный кэш генерируется из архивов — внедрено (4167 сущностей).
- [ ] Имена примитивов в кэше vs тесты — согласовать (см. Next Steps).
- [ ] Версии в документации — синхронизировать.

## Next Steps (кратко)

1) Совместимость имен примитивов
    - Нормализовать имена при загрузке кэша (сохранять «Число» как базовое имя и «Число (Number)» как display),
       либо адаптировать тесты под оба формата. Цель — 100% зеленые тесты.
2) Синхронизация версий
    - Запустить version-sync или вручную привести Cargo.toml/README/docs к единой версии.
3) Документация
    - Обновить README раздел статуса (убрать устаревшие пометки «NOT IMPLEMENTED» там, где реализовано).

## Примечание

Этот документ объединяет и замещает ANALYZER_UNIFICATION.md, REFACTORING_ANALYSIS.md, REFACTORING_PROGRESS.md. Исторические материалы можно восстановить из истории git при необходимости.